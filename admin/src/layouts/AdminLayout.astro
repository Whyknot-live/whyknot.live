---
export interface Props {
  title?: string;
  description?: string;
}

const { title = "Admin Dashboard", description = "WhyKnot Admin Panel" } =
  Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="robots" content="noindex, nofollow" />
    <title>{title} | WhyKnot Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/png"
      href="/images/logo-y-knot-transparent.png"
    />
    <link rel="apple-touch-icon" href="/images/logo-y-knot-transparent.png" />
    <style is:global>
      @import "../styles/admin.css";
    </style>
  </head>
  <body>
    <!-- Theme initialization script -->
    <script is:inline>
      (function () {
        const savedTheme = localStorage.getItem("theme");
        const systemPrefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;

        let theme;
        if (savedTheme && (savedTheme === "light" || savedTheme === "dark")) {
          theme = savedTheme;
        } else {
          theme = systemPrefersDark ? "dark" : "light";
        }

        document.documentElement.setAttribute("data-theme", theme);
      })();
    </script>

    <!-- Admin API initialization - must run before page scripts -->
    <script is:inline>
      (function() {
        function isLocalhostOrigin(origin) {
          try {
            var url = new URL(origin);
            if (url.hostname === "localhost") {
              return true;
            }
            return url.hostname.startsWith("127.") || url.hostname === "[::1]";
          } catch (e) {
            return false;
          }
        }

        function resolveApiBaseUrl() {
          // For development, use localhost with port 9000
          if (isLocalhostOrigin(window.location.origin)) {
            return "http://localhost:9000/api";
          }
          // In production on Render, the API is on a different subdomain (no port)
          // Admin: admin-whyknot-live.onrender.com -> API: api-whyknot-live.onrender.com
          var hostname = window.location.hostname;
          if (hostname.startsWith('admin-') || hostname.startsWith('admin.')) {
            var apiHostname = hostname.replace(/^admin[-.]/, 'api-');
            return window.location.protocol + '//' + apiHostname + '/api';
          }
          // Fallback: same origin /api (for proxied setups)
          return window.location.origin + '/api';
        }

        var adminBaseURL;
        try {
          adminBaseURL = resolveApiBaseUrl();
        } catch (error) {
          console.error(error);
          document.body.innerHTML =
            '<main class="config-error"><h1>Configuration error</h1><p>Admin API URL is not configured.</p></main>';
          throw error;
        }

        // Global admin utilities
        window.adminAPI = {
          baseURL: adminBaseURL,

          getToken: function() {
            return null; // Cookie-based auth, no token
          },

          setToken: function() {
            // No-op for cookie-based auth
          },

          clearToken: function() {
            // No-op for cookie-based auth
          },

          // Check if authenticated by verifying with backend (graceful - no 401 errors)
          isAuthenticated: function() {
            var self = this;
            return fetch(self.baseURL + "/admin/check", {
              method: "GET",
              credentials: "include"
            })
              .then(function(response) {
                if (!response.ok) return false;
                return response.json();
              })
              .then(function(data) {
                return data && data.authenticated === true;
              })
              .catch(function() {
                return false;
              });
          },

          fetch: function(endpoint, options) {
            var self = this;
            options = options || {};
            var headers = Object.assign(
              { "Content-Type": "application/json" },
              options.headers || {}
            );

            return fetch(self.baseURL + endpoint, Object.assign({}, options, {
              headers: headers,
              credentials: "include"
            })).then(function(response) {
              if (response.status === 401) {
                window.location.href = "/";
                throw new Error("Unauthorized");
              }
              return response;
            });
          },

          logout: function() {
            var self = this;
            return self.fetch("/admin/logout", { method: "POST" })
              .catch(function() {
                // Ignore errors
              })
              .then(function() {
                window.location.href = "/";
              });
          }
        };
      })();
    </script>

    <slot />
  </body>
</html>
